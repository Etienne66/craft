import torch
import torch.nn as nn

torch.backends.cuda.matmul.allow_tf32 = False
torch.backends.cudnn.allow_tf32 = False

device = 'cuda' # the bug occurs less frequently on cpu.

def test_consistency(P, C):
    conv = nn.Conv2d(C, C, kernel_size=(3, 3), stride=(1, 1), padding=(P, P))
    if device == 'cuda':
        conv.cuda()

    x4_shape = [4, C, 40, 40]
    x4  = torch.randn(x4_shape, device=device)
    x1 = x4[:1]
    x2 = x4[:2]
    y4  = conv(x4)
    y1  = conv(x1)
    y2  = conv(x2)

    y1_diff = (y4[:1] != y1).sum().item()
    y2_diff = (y4[:2] != y2).sum().item()
    if y1_diff == 0 and y2_diff == 0:
        return
    print(C, y1_diff, y2_diff)

for P in (0, 1):
    print(f"padding={P}")
    for C in range(3, 40):
        test_consistency(P, C)

'''
On cuda 11.5, pytorch 1.10:
padding=0
3 3420 6827
4 4625 9232
5 6065 12054
6 7078 14187
7 8449 16922
8 9957 19986
9 11093 22197
10 12581 25131
11 13753 27604
12 15174 30318
13 16600 33143
14 17872 35741
15 19261 38424
16 20199 40389
17 21850 43742
18 23264 46506
19 24591 49254
20 25856 51857
padding=1
3 3738 7446
4 5137 10231
5 6579 13204
6 7903 15804
7 9571 19116
8 10900 21715
9 12357 24688
10 13609 27283
11 15152 30261
12 16794 33489
13 18183 36284
14 19726 39455
15 21232 42526
16 22787 45567
17 24189 48457
18 25719 51438
19 27159 54313
20 28704 57367

On CPU, pytorch 1.10:
padding=0
3 3010 0
4 4239 0
5 5588 0
6 6973 0
7 8255 0
8 9520 0
9 10834 0
10 12193 0
11 13358 0
12 14961 0
padding=1
3 3081 0
4 4723 0
5 6151 0
6 7739 0
7 9191 0
8 10566 0
9 11998 0
10 13513 0
11 15090 0
12 16433 0

On CPU, pytorch 1.9.0:
padding=0
3 3302 0
4 4628 0
5 5946 0
6 7243 0
7 8551 0
8 9947 0
9 11085 0
10 12382 0
11 13732 0
12 15144 0
padding=1
3 3693 0
4 5171 0
5 6545 0
6 8021 0
7 9457 0
8 11027 0
9 12365 0
10 13772 0
11 15187 0
12 16656 0

On cuda 11.0, pytorch 1.9.0:
padding=0
29 41873 83743
30 43318 86633
31 44761 89519
32 46204 92406
33 47651 95290
34 49087 98186
35 50535 101073
36 51977 103957
37 53422 106847
38 54864 109730
39 56309 112622
padding=1
7 11199 0
8 12798 0
9 14400 0
10 16000 0
11 17599 0
12 19199 0
13 20798 0
14 22398 0
15 23996 0
16 25597 0
17 27199 0
18 28800 0
19 30398 0
20 31997 0
21 33596 0
22 35197 0
23 36794 0
24 38395 0
25 39990 0
26 41594 0
27 43196 0
28 44792 0
29 46396 92791
30 47994 95991
31 49598 99193
32 51197 102385
33 52793 105585
34 54388 108785
35 55992 111988
36 57589 115192
37 59194 118384
38 60793 121585
39 62393 124787

On cuda 11.1, pytorch 1.9.0:
padding=0
padding=1
13 18184 0
14 19660 0
15 21221 0
16 22664 0
17 24265 0
18 25580 0
19 27217 0
20 28817 0
21 30162 0
22 31806 0
23 33242 0
24 34913 0
25 36333 72563
26 37791 75463
27 39429 78650
28 40839 81740
29 42492 85135
30 43902 87780
31 45462 90772
32 46991 94056
33 48605 97172
34 50079 100333
35 51649 103363
36 53157 106433
37 54717 109208
38 56342 112733
39 57722 115343

'''